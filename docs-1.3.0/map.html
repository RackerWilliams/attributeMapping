

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Attribute Mapping Basics &mdash; Attribute Mapping Policy Reference v1.3.0.1-SNAPSHOT</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Attribute Mapping Policy Reference v1.3.0.1-SNAPSHOT" href="index.html"/>
        <link rel="next" title="Attribute Mapping Examples" href="examples.html"/>
        <link rel="prev" title="Introduction" href="intro.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Attribute Mapping Policy Reference
          

          
          </a>

          
            
            
              <div class="version">
                1.3.0.1-SNAPSHOT
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Attribute Mapping Basics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-saml-assertion">The SAML Assertion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#parts-of-the-saml-assertion">Parts of the SAML Assertion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#signing-saml-assertions">Signing SAML Assertions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#required-attributes">Required Attributes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#domain">Domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="#name">Name</a></li>
<li class="toctree-l3"><a class="reference internal" href="#email">Email</a></li>
<li class="toctree-l3"><a class="reference internal" href="#roles">Roles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#expire">Expire</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-attributes">Other Attributes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mapping-attributes">Mapping Attributes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mapping-attributes-with-xpath">Mapping Attributes with XPath</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#parts-of-the-mapping-policy">Parts of the Mapping Policy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-xpath-in-the-mapping-policy">Using XPath in the Mapping Policy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-pt-substitution">Using the {Pt()} Substitution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-mapping-get-attributes-call">Using the mapping:get-attributes Call</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-ats-and-at-substitutions">Using the {Ats()} and {At()} Substitutions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-d-substitution">Using the {D} Substitution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Attribute Mapping Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="xpath.html">XPath Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="yaml.html">YAML Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="common/common-end.html">Document history and additional information</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Attribute Mapping Policy Reference</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Attribute Mapping Basics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="attribute-mapping-basics">
<h1>Attribute Mapping Basics<a class="headerlink" href="#attribute-mapping-basics" title="Permalink to this headline">#</a></h1>
<p>Attribute mapping policies describe a means of extracting a set of
well known identity attributes from a signed SAML assertion produced
by an Identity Service Provider (IDP).  We’ll begin this section by
looking at a sample SAML assertion in detail, we’ll then describe the
attributes that identity needs to extract from the assertion in order
to operate, and we’ll wrap up by walking through the construction of a
mapping policy that extracts those attributes from the assertion.</p>
<div class="section" id="the-saml-assertion">
<h2>The SAML Assertion<a class="headerlink" href="#the-saml-assertion" title="Permalink to this headline">#</a></h2>
<p>When an Identity Provider successfully authenticates a user it
presents Rackspace Identity with a SAML Assertion, much like the one
below:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Example SAML Assertion.</span><a class="headerlink" href="#id3" title="Permalink to this code">#</a></div>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;saml2p:Response</span> <span class="na">xmlns:saml2p=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span>
                 <span class="na">xmlns:xs=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema&quot;</span>
                 <span class="na">xmlns:ds=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span>
                 <span class="na">xmlns:saml2=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</span>
                 <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
                 <span class="na">ID=</span><span class="s">&quot;_7fcd6173-e6e0-45a4-a2fd-74a4ef85bf30&quot;</span>
                 <span class="na">IssueInstant=</span><span class="s">&quot;2015-12-04T15:47:15.057Z&quot;</span>
                 <span class="na">Version=</span><span class="s">&quot;2.0&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;saml2:Issuer&gt;</span>http://test.rackspace.com<span class="nt">&lt;/saml2:Issuer&gt;</span>
  <span class="nt">&lt;ds:Signature&gt;</span>
      <span class="nt">&lt;ds:SignedInfo&gt;</span>
         <span class="nt">&lt;ds:CanonicalizationMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="nt">/&gt;</span>
         <span class="nt">&lt;ds:SignatureMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;</span><span class="nt">/&gt;</span>
         <span class="nt">&lt;ds:Reference</span> <span class="na">URI=</span><span class="s">&quot;#_1105c5b8-28d4-45e5-a6e4-bc4179f5a111&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ds:Transforms&gt;</span>
               <span class="nt">&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;</span><span class="nt">/&gt;</span>
               <span class="nt">&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/ds:Transforms&gt;</span>
            <span class="nt">&lt;ds:DigestMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/04/xmlenc#sha256&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;ds:DigestValue&gt;</span>JaeeD+wkw297KPF+BKpdacRtaPmQKFD+DqXQ3JE3Aus=<span class="nt">&lt;/ds:DigestValue&gt;</span>
         <span class="nt">&lt;/ds:Reference&gt;</span>
      <span class="nt">&lt;/ds:SignedInfo&gt;</span>
      <span class="nt">&lt;ds:SignatureValue&gt;</span>kDBwO3xYaxITVS7ZZIy9AGOlk16Y5E0BlqU12QlRpWGfiwjtgok4p5q3YQS+N/Pxh84JUIjd7i+n0to/2yJyaCfoSA2SIUUf448lTtHNzVmjiC4WiUmUTRGaxUpsdcYUkjFAVAS40yGDBLXMYn/JYS4cbRV52/RTJ5smCCpqBMjgzhVaeAqJif/gXGjvMLl4RFN8JGvHZGzpjCb14UdKhVqfP0ZumLo4cLIWd3Ch49zRBQBgchbFqEJbTdPPLTJ4SMIEYm5RwX4PtQ2Ce94u8IGXkIhYf32H43l+955a35XGh37hcZMLZEzjk4FBMqSScupKqDej1c0m34MkeRGMlQ==<span class="nt">&lt;/ds:SignatureValue&gt;</span>
      <span class="nt">&lt;ds:KeyInfo&gt;</span>
         <span class="nt">&lt;ds:X509Data&gt;</span>
            <span class="nt">&lt;ds:X509Certificate&gt;</span>MIIC6jCCAdKgAwIBAgIQE+gZKcmH841I4gYjUiHCSDANBgkqhkiG9w0BAQsFADAxMS8wLQYDVQQDEyZBREZTIFNpZ25pbmcgLSBhZGZzLmNvbnRvc293aWRnZXRzLmNvbTAeFw0xNjA2MTYwMDUyNTZaFw0xNzA2MTYwMDUyNTZaMDExLzAtBgNVBAMTJkFERlMgU2lnbmluZyAtIGFkZnMuY29udG9zb3dpZGdldHMuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAna30lllMTaivaXPCjrW7VcRI6BsPs0iVxV559I9UONENSldX9pYTPlqLzxTP1RAVzfbGNoSvNelXrc0cb6jslgi+0Ya0jxrj1CsxQDgLtZeZchwWUYnJgsvk/HHfXiQBrWPLaZbImPNVvzG1zlYoQyQHTe1Nvr1m5Lv9foruSnw4My2LP4M27ZLPGL7rLaqpBg0E9sMX0iIrucNNN6AdyyPsR8oAUtV//QB49pCk+/rb3UtSDyGrdFFD+sJBDiAXYjTGzzYxYnMjckBZQfPKMWRntGwe7lM1KkX7mtUr9pNSvX1mQS/PHxhIcvO7aWKc15FJKzFmtdAEM2mvZjnCtwIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQBj5cSPBQGyICJZHsMXA2KddWxSUqtYSBDPWYVsW9gJSMYiJBjdEnR1aGpw5K6iYei7KCACH717VQNfEF64qnBCbOvWc7FmZ3V0n4plfyZYuexbbZqp7RTi+J1q2xPsdb8MB7138YhXCc3Uf1p0oEuw+hKZ5rt4srcfgxuEauKXhnaI/UAOWOgDslzTuku+ogPsHBkc7wfH2CS9UqA3JUVJksR42yMg/Y47DUTp0Ma02RoVIfjFh+y3lX01O7B3ccCCdiKaSxcnLQ8n/ypn7LBhUUWDWZVIBj1flioohFMc5gU2Jl2Ueki72yxOwKVehqYgBHLPZBCUQUJDnUsbJJgb<span class="nt">&lt;/ds:X509Certificate&gt;</span>
         <span class="nt">&lt;/ds:X509Data&gt;</span>
      <span class="nt">&lt;/ds:KeyInfo&gt;</span>
  <span class="nt">&lt;/ds:Signature&gt;</span>
  <span class="nt">&lt;saml2p:Status&gt;</span>
      <span class="nt">&lt;saml2p:StatusCode</span> <span class="na">Value=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/saml2p:Status&gt;</span>
  <span class="nt">&lt;saml2:Assertion</span> <span class="na">ID=</span><span class="s">&quot;_406fb7fe-a519-4919-a42c-f67794a670a5&quot;</span>
                    <span class="na">IssueInstant=</span><span class="s">&quot;2017-11-15T16:19:06.310Z&quot;</span>
                    <span class="na">Version=</span><span class="s">&quot;2.0&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;saml2:Issuer&gt;</span>http://my.rackspace.com<span class="nt">&lt;/saml2:Issuer&gt;</span>
      <span class="nt">&lt;ds:Signature&gt;</span>
         <span class="nt">&lt;ds:SignedInfo&gt;</span>
            <span class="nt">&lt;ds:CanonicalizationMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;ds:SignatureMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;ds:Reference</span> <span class="na">URI=</span><span class="s">&quot;#_a8a6920c-d4eb-467f-85df-6fa2767ae63d&quot;</span><span class="nt">&gt;</span>
               <span class="nt">&lt;ds:Transforms&gt;</span>
                  <span class="nt">&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;</span><span class="nt">/&gt;</span>
                  <span class="nt">&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="nt">/&gt;</span>
               <span class="nt">&lt;/ds:Transforms&gt;</span>
               <span class="nt">&lt;ds:DigestMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/04/xmlenc#sha256&quot;</span><span class="nt">/&gt;</span>
               <span class="nt">&lt;ds:DigestValue&gt;</span>uQmSKQT03SRunafqzpb6v159a+jMVvTqmBCFYn17e7s=<span class="nt">&lt;/ds:DigestValue&gt;</span>
            <span class="nt">&lt;/ds:Reference&gt;</span>
         <span class="nt">&lt;/ds:SignedInfo&gt;</span>
         <span class="nt">&lt;ds:SignatureValue&gt;</span>cYKqfE92hWqaPylJIcl89U9TKNzJXcFIPO0fvohg70zLB4JWnYlIKOz7S9XFUvS24mN47XS1T8DeR0IGITBMhqA/GCM624SOW0QjIRhQ9gh6/ONlyuAxGbVDo5tYb82sICFa9sMWI2Vr5ZH2LeTqyvsBRnlWBkZIw4hS2PBDHbhcnILUGX9uUDRcOrONAEMimnB7cNmZxSwQgdPfupyS39oedrUAiORa7GMII8GglWoj6Jy8SX0fQKXfsXD+wC5XFw76WAKJjSCuEkrXfxMQia/2H1tE24zNgZd6Y+uQ2Nh8YlUvO+DaMoj7mTKZUBqlxQt6It4kGH0+hfqvWx1MHQ==<span class="nt">&lt;/ds:SignatureValue&gt;</span>
         <span class="nt">&lt;ds:KeyInfo&gt;</span>
            <span class="nt">&lt;ds:X509Data&gt;</span>
               <span class="nt">&lt;ds:X509Certificate&gt;</span>MIIC6jCCAdKgAwIBAgIQE+gZKcmH841I4gYjUiHCSDANBgkqhkiG9w0BAQsFADAxMS8wLQYDVQQDEyZBREZTIFNpZ25pbmcgLSBhZGZzLmNvbnRvc293aWRnZXRzLmNvbTAeFw0xNjA2MTYwMDUyNTZaFw0xNzA2MTYwMDUyNTZaMDExLzAtBgNVBAMTJkFERlMgU2lnbmluZyAtIGFkZnMuY29udG9zb3dpZGdldHMuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAna30lllMTaivaXPCjrW7VcRI6BsPs0iVxV559I9UONENSldX9pYTPlqLzxTP1RAVzfbGNoSvNelXrc0cb6jslgi+0Ya0jxrj1CsxQDgLtZeZchwWUYnJgsvk/HHfXiQBrWPLaZbImPNVvzG1zlYoQyQHTe1Nvr1m5Lv9foruSnw4My2LP4M27ZLPGL7rLaqpBg0E9sMX0iIrucNNN6AdyyPsR8oAUtV//QB49pCk+/rb3UtSDyGrdFFD+sJBDiAXYjTGzzYxYnMjckBZQfPKMWRntGwe7lM1KkX7mtUr9pNSvX1mQS/PHxhIcvO7aWKc15FJKzFmtdAEM2mvZjnCtwIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQBj5cSPBQGyICJZHsMXA2KddWxSUqtYSBDPWYVsW9gJSMYiJBjdEnR1aGpw5K6iYei7KCACH717VQNfEF64qnBCbOvWc7FmZ3V0n4plfyZYuexbbZqp7RTi+J1q2xPsdb8MB7138YhXCc3Uf1p0oEuw+hKZ5rt4srcfgxuEauKXhnaI/UAOWOgDslzTuku+ogPsHBkc7wfH2CS9UqA3JUVJksR42yMg/Y47DUTp0Ma02RoVIfjFh+y3lX01O7B3ccCCdiKaSxcnLQ8n/ypn7LBhUUWDWZVIBj1flioohFMc5gU2Jl2Ueki72yxOwKVehqYgBHLPZBCUQUJDnUsbJJgb<span class="nt">&lt;/ds:X509Certificate&gt;</span>
            <span class="nt">&lt;/ds:X509Data&gt;</span>
         <span class="nt">&lt;/ds:KeyInfo&gt;</span>
      <span class="nt">&lt;/ds:Signature&gt;</span>
      <span class="nt">&lt;saml2:Subject&gt;</span>
         <span class="nt">&lt;saml2:NameID</span> <span class="na">Format=</span><span class="s">&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&quot;</span><span class="nt">&gt;</span>john.doe<span class="nt">&lt;/saml2:NameID&gt;</span>
         <span class="nt">&lt;saml2:SubjectConfirmation</span> <span class="na">Method=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;saml2:SubjectConfirmationData</span> <span class="na">NotOnOrAfter=</span><span class="s">&quot;2017-11-17T16:19:06.298Z&quot;</span><span class="nt">/&gt;</span>
         <span class="nt">&lt;/saml2:SubjectConfirmation&gt;</span>
      <span class="nt">&lt;/saml2:Subject&gt;</span>
      <span class="nt">&lt;saml2:AuthnStatement</span> <span class="na">AuthnInstant=</span><span class="s">&quot;2017-11-15T16:19:04.055Z&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;saml2:AuthnContext&gt;</span>
            <span class="nt">&lt;saml2:AuthnContextClassRef&gt;</span>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
            <span class="nt">&lt;/saml2:AuthnContextClassRef&gt;</span>
         <span class="nt">&lt;/saml2:AuthnContext&gt;</span>
      <span class="nt">&lt;/saml2:AuthnStatement&gt;</span>
      <span class="nt">&lt;saml2:AttributeStatement&gt;</span>
         <span class="nt">&lt;saml2:Attribute</span> <span class="na">Name=</span><span class="s">&quot;roles&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;saml2:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:string&quot;</span><span class="nt">&gt;</span>nova:admin<span class="nt">&lt;/saml2:AttributeValue&gt;</span>
         <span class="nt">&lt;/saml2:Attribute&gt;</span>
         <span class="nt">&lt;saml2:Attribute</span> <span class="na">Name=</span><span class="s">&quot;domain&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;saml2:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:string&quot;</span><span class="nt">&gt;</span>323676<span class="nt">&lt;/saml2:AttributeValue&gt;</span>
         <span class="nt">&lt;/saml2:Attribute&gt;</span>
         <span class="nt">&lt;saml2:Attribute</span> <span class="na">Name=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;saml2:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:string&quot;</span><span class="nt">&gt;</span>john.doe@rackspace.com<span class="nt">&lt;/saml2:AttributeValue&gt;</span>
         <span class="nt">&lt;/saml2:Attribute&gt;</span>
         <span class="nt">&lt;saml2:Attribute</span> <span class="na">Name=</span><span class="s">&quot;groups&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;saml2:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:string&quot;</span><span class="nt">&gt;</span>group1<span class="nt">&lt;/saml2:AttributeValue&gt;</span>
            <span class="nt">&lt;saml2:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:string&quot;</span><span class="nt">&gt;</span>group2<span class="nt">&lt;/saml2:AttributeValue&gt;</span>
            <span class="nt">&lt;saml2:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:string&quot;</span><span class="nt">&gt;</span>group3<span class="nt">&lt;/saml2:AttributeValue&gt;</span>
         <span class="nt">&lt;/saml2:Attribute&gt;</span>
         <span class="nt">&lt;saml2:Attribute</span> <span class="na">Name=</span><span class="s">&quot;FirstName&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;saml2:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:string&quot;</span><span class="nt">&gt;</span>John<span class="nt">&lt;/saml2:AttributeValue&gt;</span>
         <span class="nt">&lt;/saml2:Attribute&gt;</span>
         <span class="nt">&lt;saml2:Attribute</span> <span class="na">Name=</span><span class="s">&quot;LastName&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;saml2:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:string&quot;</span><span class="nt">&gt;</span>Doe<span class="nt">&lt;/saml2:AttributeValue&gt;</span>
         <span class="nt">&lt;/saml2:Attribute&gt;</span>
      <span class="nt">&lt;/saml2:AttributeStatement&gt;</span>
  <span class="nt">&lt;/saml2:Assertion&gt;</span>
<span class="nt">&lt;/saml2p:Response&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>The assertion describes a view of the user that has successfully
logged in. It contains within it all of the information deemed by the
IDP to be relevant to the Service Provider (the SP—which in this
case is Rackspace).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For help configuring Third Party identity providers (such as Active
Directory Federation Services, Okta, and others) please refer to the
<a class="reference external" href="http://developer.rackspace.com/docs/rackspace-federation">Rackspace Identity Federation User Guide</a>.</p>
</div>
<div class="section" id="parts-of-the-saml-assertion">
<h3>Parts of the SAML Assertion<a class="headerlink" href="#parts-of-the-saml-assertion" title="Permalink to this headline">#</a></h3>
<p>In this section, we break down the SAML assertion listed above into
its relevant parts. Note first that per the SAML protocol, the
assertion itself is wrapped in a <code class="docutils literal"><span class="pre">&lt;saml2p:Response</span> <span class="pre">/&gt;</span></code> element which
begins on line 2.  The actual assertion (<code class="docutils literal"><span class="pre">&lt;saml2p:Assertion</span> <span class="pre">/&gt;</span></code>)
begins in line 34.</p>
<dl class="docutils">
<dt>Issuer (37):</dt>
<dd>The issuer is the system that generated (or issued) the assertion.
This is identified as a URI.</dd>
<dt>Signature (38–57):</dt>
<dd>The XML Signature of the assertion part of the request. The
signature is used to verify that that the assertion was indeed
produced by the issuer.</dd>
<dt>Subject (58–63):</dt>
<dd>The subject is used to identify the identity (or user) that the
assertion is about.</dd>
<dt>AuthnStatement (64–69):</dt>
<dd>The AuthnStatement contains details on how the subject
authenticated.</dd>
<dt>AttributeStatement (70–91):</dt>
<dd>This section contains a list of arbitrary attributes associated with
the subject.  Each attribute in the list is essentially a name/value
pair.  Note, that values are of a type identified by the
<code class="docutils literal"><span class="pre">xsi:type</span></code> XML attribute—in this case they are all strings.
Also note, that attributes may have multiple values.  The groups
attribute defined in 80–84, for example, contains 3 separate values
(group1, group2, and group3).</dd>
</dl>
</div>
<div class="section" id="signing-saml-assertions">
<h3>Signing SAML Assertions<a class="headerlink" href="#signing-saml-assertions" title="Permalink to this headline">#</a></h3>
<p>Both the SAML Response (2) and the SAML Assertion (34) may be signed.
Rackspace Identity may verify both signatures. It’s important to note
however that while signing the SAML Response is optional, signing the
SAML Assertion is strictly required. This means that a message that
contains a single signature at the SAML Response level will be
rejected.</p>
<p>It is possible for a SAML Response to contain multiple assertions. In
this case, all assertions must be signed and they must all be issued
by the same issuer.  Rackspace Identity typically examines only the
first assertion for authorization data, this behavior can be easily
overwritten with a mapping policy.</p>
</div>
</div>
<div class="section" id="required-attributes">
<h2>Required Attributes<a class="headerlink" href="#required-attributes" title="Permalink to this headline">#</a></h2>
<p>We now examine the attributes that Rackspace Identity requires in
order to successfully authenticate a user.  As we look through these,
we’ll examine where we can retrieve these attributes from the SAML
Response above.</p>
<div class="section" id="domain">
<h3>Domain<a class="headerlink" href="#domain" title="Permalink to this headline">#</a></h3>
<p>Rackspace Identity keeps information about users, roles, and other
entitlements in a domain. When a user federates into Rackspace, the
user is placed in a single identity domain. Each domain is accessed
via a unique alpha-numeric ID which Rackspace usually sets to be the
same the user’s account ID. This ID is required when a federated user
requests access.  This is especially important because a customer is
allowed to create multiple domains and Rackspace Identity needs to
place the federated user in the correct one.</p>
<p>In the SAML Assertion above the domain is passed as a SAML attribute
in lines 74–76. This implies that the identity provider was
pre-configured to emit the correct value. It is not strictly required
that IDP do this since most federated users target a single domain and
the domain value can be easily hard coded in an attribute mapping
policy as we’ll see later in this chapter.</p>
</div>
<div class="section" id="name">
<h3>Name<a class="headerlink" href="#name" title="Permalink to this headline">#</a></h3>
<p>This is the username of the federated user.  Rackspace Identity
assumes that each user will be identified with a unique username, and
that the same user will have the same username from one federated
login to the next.</p>
<p>In the SAML Assertion above the username is identified by the
<code class="docutils literal"><span class="pre">NameID</span></code> in the Subject section of the assertion (line 59). That
said, it is possible for an IDP to return a stable username as an
attribute in the AttributeStatement section.</p>
</div>
<div class="section" id="email">
<h3>Email<a class="headerlink" href="#email" title="Permalink to this headline">#</a></h3>
<p>This is the email of the federated user.  In the SAML assertion it is
identified as an attribute in the AttributeStatement section (lines
77–79). Some IDPs will make no distinction between a username and an
email, in which case the email will be located in the Subject section.</p>
</div>
<div class="section" id="roles">
<h3>Roles<a class="headerlink" href="#roles" title="Permalink to this headline">#</a></h3>
<p>Another attribute expected by Rackspace Identity is the list of roles
that should be assigned to the federated user.  Rackspace Identity
only allows roles that it recognizes to be assigned.  See the
<a class="reference external" href="http://developer.rackspace.com/docs/rackspace-federation">Rackspace Identity Federation User Guide</a> for the most current <a class="reference external" href="https://developer.rackspace.com/docs/rackspace-federation/attribmapping-basics/full-roles/">list
of allowed roles</a>.</p>
<p>In the SAML Assertion above the list of roles is specified in an
attribute named <code class="docutils literal"><span class="pre">roles</span></code> on lines 71–73.  Note that this is a
good use case for a multi-value attribute, but in this case we only
assign the <code class="docutils literal"><span class="pre">nova:admin</span></code> role.</p>
</div>
<div class="section" id="expire">
<h3>Expire<a class="headerlink" href="#expire" title="Permalink to this headline">#</a></h3>
<p>Finally, Rackspace identity needs to understand the amount of time
that a federated user should be allowed on Rackspace systems before
the user is forced to re-authenticate.  This attribute can be
expressed in two different formats. First, an <a class="reference external" href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a> timestamp
may be provided, this timestamp should include a time zone designator.
For example, the timestamp <code class="docutils literal"><span class="pre">2017-10-04T16:20:57Z</span></code> signifies that the
user should be forced to re-authenticate after October 4th 2017 at
16:20:57 UTC.  Secondly, an <a class="reference external" href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a> duration may be specified.
For example, <code class="docutils literal"><span class="pre">PT1H2M</span></code> signifies that the user should be forced to
re-authenticate one hour and two minuets after successfully logging
in.</p>
<p>In the SAML Assertion above an expire timestamp is specified in the
<code class="docutils literal"><span class="pre">NotOnOrAfter</span></code> attribute of the SubjectConfirmationData on line 61.
In SAML, this attribute is meant to denote the time after which the
SAML Assertion should no longer be considered valid. While this
timestamp does not fit semantically with the expire attribute that
Rackspace Identity expects it still works as a reasonable default.</p>
</div>
<div class="section" id="other-attributes">
<h3>Other Attributes<a class="headerlink" href="#other-attributes" title="Permalink to this headline">#</a></h3>
<p>The attributes described in the previous sections (domain, name,
email, roles, and expire) are expected in every federated login. Some
Rackspace products may expect additional optional attributes. Please
consult the <a class="reference external" href="http://developer.rackspace.com/docs/rackspace-federation">Rackspace Identity Federation User Guide</a> for details on
these attributes.</p>
</div>
</div>
<div class="section" id="mapping-attributes">
<h2>Mapping Attributes<a class="headerlink" href="#mapping-attributes" title="Permalink to this headline">#</a></h2>
<p>So far, we’ve broken down the SAML Assertion and identified places
where we can find values for the 5 attributes that Rackspace Identity
requires.  This is summarized in the table below:</p>
<table border="1" class="docutils" id="id4">
<caption><span class="caption-text">Attributes mapped to locations</span><a class="headerlink" href="#id4" title="Permalink to this table">#</a></caption>
<colgroup>
<col width="22%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">SAML Assertion Location (Line Numbers)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>domain</td>
<td>74–76</td>
</tr>
<tr class="row-odd"><td>name</td>
<td>59</td>
</tr>
<tr class="row-even"><td>email</td>
<td>77–79</td>
</tr>
<tr class="row-odd"><td>roles</td>
<td>71–73</td>
</tr>
<tr class="row-even"><td>expire</td>
<td>61</td>
</tr>
</tbody>
</table>
<p>The values at those locations are listed here:</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>domain</td>
<td>323676</td>
</tr>
<tr class="row-even"><td>name</td>
<td>john.doe</td>
</tr>
<tr class="row-odd"><td>email</td>
<td><a class="reference external" href="mailto:john&#46;doe&#37;&#52;&#48;rackspace&#46;com">john<span>&#46;</span>doe<span>&#64;</span>rackspace<span>&#46;</span>com</a></td>
</tr>
<tr class="row-even"><td>roles</td>
<td><ul class="first last simple">
<li>nova:admin</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>expire</td>
<td>2017-11-17T16:19:06.298Z</td>
</tr>
</tbody>
</table>
<p>In a sense, this table represents an attribute mapping.  We are
mapping data located in the SAML Assertion into attributes that
Rackspace Identity requires to log in a federated user.  This is a
silly mapping, however, because mapping attributes by referring to
line numbers is extremely unpractical, inexact, and brittle. Using
XPath, on the other hand, is a more stable and practical way of
pinpointing the exact location of the data that we need. After all,
XPath was designed specifically to pinpoint and extract data form XML
documents <a class="footnote-reference" href="#j1" id="id1">[1]</a>.</p>
<div class="section" id="mapping-attributes-with-xpath">
<h3>Mapping Attributes with XPath<a class="headerlink" href="#mapping-attributes-with-xpath" title="Permalink to this headline">#</a></h3>
<p>In the table below, we replace line numbers with XPaths into the SAML
Assertion.</p>
<table border="1" class="docutils" id="id5">
<caption><span class="caption-text">Attributes mapped to XPaths</span><a class="headerlink" href="#id5" title="Permalink to this table">#</a></caption>
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">SAML Assertion Location (XPath)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>domain</td>
<td>/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[&#64;Name=’domain’]/saml2:AttributeValue[1]</td>
</tr>
<tr class="row-odd"><td>name</td>
<td>/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:NameID</td>
</tr>
<tr class="row-even"><td>email</td>
<td>/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[&#64;Name=’email’]/saml2:AttributeValue[1]</td>
</tr>
<tr class="row-odd"><td>roles</td>
<td>/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[&#64;Name=’roles’]/saml2:AttributeValue</td>
</tr>
<tr class="row-even"><td>expire</td>
<td>/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/&#64;NotOnOrAfter</td>
</tr>
</tbody>
</table>
<p>We can easily turn this table into an attribute mapping policy:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">mapping</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">RAX-1</span>
  <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
    <span class="no">Simple policy where we select required attributes via an XPath.</span>
  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">local</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">domain</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pts(/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;domain&#39;]/saml2:AttributeValue[1])}&quot;</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>   <span class="s">&quot;{Pts(/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:NameID)}&quot;</span>
        <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Pts(/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;email&#39;]/saml2:AttributeValue[1])}&quot;</span>
        <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Pts(/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;roles&#39;]/saml2:AttributeValue)}&quot;</span>
        <span class="l-Scalar-Plain">expire</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pts(/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@NotOnOrAfter)}&quot;</span>
</pre></div>
</td></tr></table></div>
<p>Let’s walk through the policy above in detail and examine how XPath is
used to extract the attribute values.</p>
<div class="section" id="parts-of-the-mapping-policy">
<h4>Parts of the Mapping Policy<a class="headerlink" href="#parts-of-the-mapping-policy" title="Permalink to this headline">#</a></h4>
<p>The mapping policy is YAML document that contains instructions aimed
at retrieving (or deriving) identity attributes from a SAML
Assertion. You can think of it as a simple script that executes every
time a SAML Assertion is presented to Rackspace Identity. In this
section, we break the mapping policy above into its relevant parts.</p>
<dl class="docutils">
<dt>mapping (2):</dt>
<dd>The mapping policy is always contained in a single top-level
<code class="docutils literal"><span class="pre">mapping</span></code> object.</dd>
<dt>version (3):</dt>
<dd>The <code class="docutils literal"><span class="pre">version</span></code> key identifies the version of the mapping policy
language.  It is a required attribute and should always have the
value of <code class="docutils literal"><span class="pre">RAX-1</span></code>. The mapping policy language described here is
based on the <a class="reference external" href="https://docs.openstack.org/keystone/latest/advanced-topics/federation/mapping_combinations.html">Mapping Combinations</a> language by the OpenStack
Keystone and the version name is used to differentiate a Rackspace
Identity mapping policy from a Keystone mapping policy.</dd>
<dt>description (4):</dt>
<dd>The <code class="docutils literal"><span class="pre">description</span></code> key provides a human readable description of the
mapping policy. This description is optional.</dd>
<dt>rules (6):</dt>
<dd>A mapping policy is made up of a collection of rules. These rules
are encapsulated by the <code class="docutils literal"><span class="pre">rules</span></code> array.  A policy is required to
contain at least one rule.</dd>
<dt>rule (7–13):</dt>
<dd><p class="first">Lines 7–13 contain a rule that drives the policy. A rule may contain
a <code class="docutils literal"><span class="pre">local</span></code> and a <code class="docutils literal"><span class="pre">remote</span></code> section.  Both <code class="docutils literal"><span class="pre">local</span></code> and <code class="docutils literal"><span class="pre">remote</span></code>
sections are optional (in this case, we don’t need a <code class="docutils literal"><span class="pre">remote</span></code>),
however, there should be at least one rule with a <code class="docutils literal"><span class="pre">local</span></code> section.</p>
<p>It’s important to note that things are local or remote from the
perspective of Rackspace Identity. For example, the <code class="docutils literal"><span class="pre">local</span></code>
section contains statements about the user within Rackspace Identity
(the local user).  The remote section contains statements about the
user as its presented by the IDP (the remote user).</p>
<p class="last">Lines 8–13 describe what the local user should look like—in other
words they describe the attributes of the local user. Here, we
specify each of the required identity attributes and describe how
they can be obtained from an XPath.</p>
</dd>
</dl>
</div>
<div class="section" id="using-xpath-in-the-mapping-policy">
<h4>Using XPath in the Mapping Policy<a class="headerlink" href="#using-xpath-in-the-mapping-policy" title="Permalink to this headline">#</a></h4>
<p>You’ll note that the XPaths in the mapping policy are contained within
something that looks like this <code class="docutils literal"><span class="pre">{Pts()}</span></code>—this is known as an
XPath substitution. There are various types of substitutions in the
mapping policy language each of which is encapsulated by curly braces
<code class="docutils literal"><span class="pre">{}</span></code>. Substitutions are only allowed in the local part of the
mapping policy, they help set values for local attributes in that they
are always replaced (or substituted) by other content. In the case of
the XPath substitution it is replaced by the result of the XPath
within the parenthesis when executed against the SAML Assertion.</p>
<p>It is important to note that spaces matter in a substitution.  In
order to be interpreted correctly there should be no spaces between
the prologue of the substitution <code class="docutils literal"><span class="pre">{Pts(</span></code> and the epilogue of the
substitution <code class="docutils literal"><span class="pre">)}</span></code>.</p>
<table border="1" class="docutils" id="id6">
<caption><span class="caption-text">XPath Substitutions</span><a class="headerlink" href="#id6" title="Permalink to this table">#</a></caption>
<colgroup>
<col width="82%" />
<col width="18%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">XPath Substitution</th>
<th class="head">Valid?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">{Pts(//saml2:AttributeValue[1])}</span></code></td>
<td>valid</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">{Pts(</span>&#160; <span class="pre">//saml2:AttributeValue[1]</span>&#160; <span class="pre">)}</span></code></td>
<td>valid</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">{Pt</span> <span class="pre">s(//saml2:AttributeValue[1]</span>&#160; <span class="pre">)}</span></code></td>
<td>invalid</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">{Pts(//saml2:AttributeValue[1])</span> <span class="pre">}</span></code></td>
<td>invalid</td>
</tr>
</tbody>
</table>
<p>You’ll notice that the XPath substitution refers to elements in
certain namespaces (<code class="docutils literal"><span class="pre">saml2p</span></code>, <code class="docutils literal"><span class="pre">saml2</span></code>). These namespace prefixes,
which are common to SAML, are always predefined. The table below
describes how namespace prefixes are mapped by default:</p>
<table border="1" class="docutils" id="id7">
<caption><span class="caption-text">Default Namespace Prefix Mapping</span><a class="headerlink" href="#id7" title="Permalink to this table">#</a></caption>
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Prefix</th>
<th class="head">Namespace URI</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>saml2</td>
<td><a class="reference external" href="urn:oasis:names:tc:SAML:2.0:assertion">urn:oasis:names:tc:SAML:2.0:assertion</a></td>
</tr>
<tr class="row-odd"><td>saml2p</td>
<td><a class="reference external" href="urn:oasis:names:tc:SAML:2.0:protocol">urn:oasis:names:tc:SAML:2.0:protocol</a></td>
</tr>
<tr class="row-even"><td>xs</td>
<td><a class="reference external" href="http://www.w3.org/2001/XMLSchema">http://www.w3.org/2001/XMLSchema</a></td>
</tr>
<tr class="row-odd"><td>xsi</td>
<td><a class="reference external" href="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</a></td>
</tr>
<tr class="row-even"><td>mapping</td>
<td><a class="reference external" href="http://docs.rackspace.com/identity/api/ext/MappingRules">http://docs.rackspace.com/identity/api/ext/MappingRules</a></td>
</tr>
</tbody>
</table>
<p>It is possible for a SAML Assertion to refer to elements in extended
namespaces not listed here. You can define additional prefixes by
adding a <code class="docutils literal"><span class="pre">namespaces</span></code> key to the mapping policy. In XPath, it’s the
namespace URI that uniquely identifies an element—the prefix is
simply a short had for this URI.  In the example below, we replace the
<code class="docutils literal"><span class="pre">saml2p</span></code> prefix with <code class="docutils literal"><span class="pre">foo</span></code>. Because the namespace URI bound to
element is the same as the previous example the two mapping policies
will produce the exact same result.</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">mapping</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">RAX-1</span>
  <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
    <span class="no">Simple policy where we select required attributes via an XPath.</span>
  <span class="l-Scalar-Plain">namespaces</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">foo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">urn:oasis:names:tc:SAML:2.0:protocol</span>
  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">local</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">domain</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pts(/foo:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;domain&#39;]/saml2:AttributeValue[1])}&quot;</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>   <span class="s">&quot;{Pts(/foo:Response/saml2:Assertion/saml2:Subject/saml2:NameID)}&quot;</span>
        <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Pts(/foo:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;email&#39;]/saml2:AttributeValue[1])}&quot;</span>
        <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Pts(/foo:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;roles&#39;]/saml2:AttributeValue)}&quot;</span>
        <span class="l-Scalar-Plain">expire</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pts(/foo:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@NotOnOrAfter)}&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="using-the-pt-substitution">
<h3>Using the {Pt()} Substitution<a class="headerlink" href="#using-the-pt-substitution" title="Permalink to this headline">#</a></h3>
<p>Notice that the XPath for retrieving the domain ends with
<code class="docutils literal"><span class="pre">saml2:AttributeValue[1]</span></code> while the XPath for retrieving the list of
roles ends <code class="docutils literal"><span class="pre">saml2:AttributeValue</span></code>.  This is because we want a single
value for a domain, but we want a list of roles.  Without the <code class="docutils literal"><span class="pre">[1]</span></code>
the XPath would return every <code class="docutils literal"><span class="pre">AttributeValue</span></code> in a SAML Assertion
for a domain—the <code class="docutils literal"><span class="pre">[1]</span></code> signifies that we are only interested
in the first value we find <a class="footnote-reference" href="#j2" id="id2">[2]</a>.</p>
<p>Because it is common to want to retrieve a single value, there’s an
alternative XPath substitution (<code class="docutils literal"><span class="pre">{Pt()}</span></code>) that always returns the
first value of an XPath result. This is useful in cases where we
expect a single value and we want to automatically protect against the
off chance that we’ll receive multiple values in a SAML assertion.</p>
<p>Given this new substitution, we can rewrite the mapping policy as
follows:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">mapping</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">RAX-1</span>
  <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
    <span class="no">Simple policy where we select required attributes via an XPath.</span>
    <span class="no">We use {Pt()} instead of {Pts()} in single value attributes to</span>
    <span class="no">avoid having to select the first attribute value in XPath.</span>
  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">local</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">domain</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pt(/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;domain&#39;]/saml2:AttributeValue)}&quot;</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>   <span class="s">&quot;{Pt(/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:NameID)}&quot;</span>
        <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Pt(/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;email&#39;]/saml2:AttributeValue)}&quot;</span>
        <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Pts(/saml2p:Response/saml2:Assertion/saml2:AttributeStatement/saml2:Attribute[@Name=&#39;roles&#39;]/saml2:AttributeValue)}&quot;</span>
        <span class="l-Scalar-Plain">expire</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pt(/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@NotOnOrAfter)}&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="using-the-mapping-get-attributes-call">
<h3>Using the mapping:get-attributes Call<a class="headerlink" href="#using-the-mapping-get-attributes-call" title="Permalink to this headline">#</a></h3>
<p>At this point, the XPaths for retrieving a domain, email, and roles
all look almost exactly the same as each other. They are all
retrieving the list of values for an attribute in the
<code class="docutils literal"><span class="pre">AttributeStatement</span></code> of the assertion by name.  Because this is a
common case, there is a predefined XPath function called
<code class="docutils literal"><span class="pre">mapping:get-attributes</span></code> that takes the name of a SAML attribute as
a string, and returns the attribute values associated with that name.</p>
<p>We can rewrite the mapping policy using this function as follows:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">mapping</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">RAX-1</span>
  <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
    <span class="no">Simple policy where we select required attributes via an</span>
    <span class="no">XPath. Here we use the mapping:get-attributes call to return</span>
    <span class="no">attribute values.</span>
  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">local</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">domain</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pt(mapping:get-attributes(&#39;domain&#39;))}&quot;</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>   <span class="s">&quot;{Pt(/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:NameID)}&quot;</span>
        <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Pt(mapping:get-attributes(&#39;email&#39;))}&quot;</span>
        <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Pts(mapping:get-attributes(&#39;roles&#39;))}&quot;</span>
        <span class="l-Scalar-Plain">expire</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pt(/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@NotOnOrAfter)}&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="using-the-ats-and-at-substitutions">
<h3>Using the {Ats()} and {At()} Substitutions<a class="headerlink" href="#using-the-ats-and-at-substitutions" title="Permalink to this headline">#</a></h3>
<p>Having an XPath function that retrieves SAML attribute values is handy
when you want to process those values in some way before returning a
result.  In some cases, however, you simply want to return the value
(or values) of a SAML attribute as is. The <code class="docutils literal"><span class="pre">{Ats()}</span></code> and <code class="docutils literal"><span class="pre">{At()}</span></code>
substitutions, do just that. These are known as attribute
substitutions. As with their XPath counterparts, the <code class="docutils literal"><span class="pre">{Ats()}</span></code>
substitution returns all values for a specific attribute name and the
<code class="docutils literal"><span class="pre">{At()}</span></code>.</p>
<p>Given these substitutions we can rewrite the policy as follows:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">mapping</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">RAX-1</span>
  <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
    <span class="no">Simple policy where we select required attributes. We use At</span>
    <span class="no">instead of Pts as a simple means of accessing an name SAML</span>
    <span class="no">attribute.</span>
  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">local</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">domain</span><span class="p-Indicator">:</span> <span class="s">&quot;{At(domain)}&quot;</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>   <span class="s">&quot;{Pt(/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:NameID)}&quot;</span>
        <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span>  <span class="s">&quot;{At(email)}&quot;</span>
        <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>  <span class="s">&quot;{Ats(roles)}&quot;</span>
        <span class="l-Scalar-Plain">expire</span><span class="p-Indicator">:</span> <span class="s">&quot;{Pt(/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@NotOnOrAfter)}&quot;</span>
</pre></div>
</td></tr></table></div>
<p>Notice that in this case the name of the attribute is not in single
quotes. We are no longer directly using XPath with attribute
substitutions, although, under the hood, these substitutions are also
interpreted as XPath statements.</p>
</div>
<div class="section" id="using-the-d-substitution">
<h3>Using the {D} Substitution<a class="headerlink" href="#using-the-d-substitution" title="Permalink to this headline">#</a></h3>
<p>There are certain default places where a mapping policy may look for a
particular identity attribute value. The default substitution
(<code class="docutils literal"><span class="pre">{D}</span></code>) is always replaced with the value at the default
location. Unlike other substitutions the default substitution is
interpreted differently depending on where the substitution is
placed. For example, if the substitution is placed as a value of the
<code class="docutils literal"><span class="pre">name</span></code> attribute it will replace itself with the default value for
name. Likewise, if <code class="docutils literal"><span class="pre">{D}</span></code> is placed in the <code class="docutils literal"><span class="pre">email</span></code> attribute it
will be replaced with the default value for email and so on.</p>
<p>What are the default locations in a SAML assertion for the five
attributes Rackspace Identity expects?  It turns out that the SAML
assertion in this chapter has all of the values in the default places!
So it’s possible, in this case, to write a mapping policy that looks
like this:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">mapping</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">RAX-1</span>
  <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
    <span class="no">The default policy.  All attributes are in the expected location</span>
    <span class="no">in the SAML assertion.</span>
  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">local</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">domain</span><span class="p-Indicator">:</span> <span class="s">&quot;{D}&quot;</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>   <span class="s">&quot;{D}&quot;</span>
        <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span>  <span class="s">&quot;{D}&quot;</span>
        <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>  <span class="s">&quot;{D}&quot;</span>
        <span class="l-Scalar-Plain">expire</span><span class="p-Indicator">:</span> <span class="s">&quot;{D}&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">#</a></h2>
<p>So far we’ve learned about the SAML Assertions and seen how to use
XPath, attribute names, and expected defaults to write mapping
polices.  All of the polices we’ve created, however, have described
simple direct mappings. In the chapters that follow we’ll start
looking at writing polices in cases where things don’t align so
perfectly.</p>
<table class="docutils footnote" frame="void" id="j1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Later versions of XPath allow extracting data from JSON
documents as well!</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="j2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>The first index in XPath is 1 not 0.  This logical and makes
sense unless you’re a software developer.</td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="examples.html" class="btn btn-neutral float-right" title="Attribute Mapping Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="intro.html" class="btn btn-neutral" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Rackspace.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.3.0.1-SNAPSHOT',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>